name: Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      new_release_published: ${{ steps.check-release.outputs.new_release_published }}
      new_release_version: ${{ steps.check-release.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get latest tag before release
        id: before-release
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag before release: $LATEST_TAG"

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0
        run: npx semantic-release

      - name: Check if new release was published
        id: check-release
        run: |
          # Fetch latest tags from remote
          git fetch --tags --force

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          PREVIOUS_TAG="${{ steps.before-release.outputs.latest_tag }}"

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Latest tag: $LATEST_TAG"

          if [ "$LATEST_TAG" != "$PREVIOUS_TAG" ] && [ "$LATEST_TAG" != "none" ]; then
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            echo "new_release_version=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "‚úÖ New release published: $LATEST_TAG"
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "new_release_version=" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No new release published"
          fi

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: release
    # Only notify if a release was published and SLACK_WEBHOOK_URL is configured
    if: |
      needs.release.outputs.new_release_published == 'true' &&
      vars.SLACK_RELEASES_CHANNEL != ''
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          RELEASE_VERSION: ${{ needs.release.outputs.new_release_version }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          # Extract just the repo name (without owner)
          REPO_SHORT_NAME="${REPO_NAME##*/}"

          # Create the release URL
          RELEASE_URL="${REPO_URL}/releases/tag/${RELEASE_VERSION}"

          # Send notification to Slack
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            --fail \
            -d @- << EOF
          {
            "channel": "${{ vars.SLACK_RELEASES_CHANNEL }}",
            "username": "Release Bot",
            "icon_emoji": ":rocket:",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üöÄ New Release Published",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n<${REPO_URL}|${REPO_NAME}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n<${RELEASE_URL}|${RELEASE_VERSION}>"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "Released via <${REPO_URL}/actions|GitHub Actions>"
                  }
                ]
              }
            ]
          }
          EOF

          echo "‚úÖ Slack notification sent for ${REPO_NAME}@${RELEASE_VERSION}"
